{% extends 'base.html' %}

{% block title %}Import Attendance Data{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-cloud-upload me-2"></i>Import Attendance Data</h1>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">Upload File</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('import_data') }}" method="post" enctype="multipart/form-data">
                    <div class="mb-4">
                        <div id="dragDropArea" class="border rounded-3 p-5 text-center position-relative">
                            <input type="file" name="excel_file" id="fileInput" class="position-absolute top-0 start-0 opacity-0" style="width:100%; height:100%;" accept=".xlsx,.xls,.csv,.pdf" onchange="updateFileName(this)">
                            <i class="bi bi-cloud-arrow-up text-primary" style="font-size: 4rem;"></i>
                            <h5 class="mt-3">Drag & Drop File Here</h5>
                            <p class="text-muted mb-2">or click to browse</p>
                            <p id="selectedFileName" class="small text-primary mt-2 fw-bold"></p>
                            <p class="small text-muted mt-3 mb-0">Accepted formats: Excel (.xlsx, .xls), CSV, PDF</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label">Import Type:</label>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="import_type" id="type_auto" value="auto" checked>
                                    <label class="form-check-label" for="type_auto">
                                        <strong>Auto-Detect</strong>
                                    </label>
                                    <small class="text-muted d-block">Automatically determine the type of data</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="import_type" id="type_standard" value="standard_excel">
                                    <label class="form-check-label" for="type_standard">
                                        <strong>Standard Format</strong>
                                    </label>
                                    <small class="text-muted d-block">Regular attendance data with one row per day</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="import_type" id="type_punch" value="punch_record">
                                    <label class="form-check-label" for="type_punch">
                                        <strong>Punch Records</strong>
                                    </label>
                                    <small class="text-muted d-block">Multiple check-ins/check-outs per day</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add auto-fill option -->
                    <div class="mb-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="auto_fill_gaps" id="auto_fill_gaps" checked>
                            <label class="form-check-label" for="auto_fill_gaps">
                                <strong>Auto-fill Missing Days</strong>
                            </label>
                            <small class="text-muted d-block">Automatically mark weekdays without records as "No Work" and weekends as "Weekend"</small>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg px-4" id="uploadBtn" disabled>
                            <i class="bi bi-upload me-2"></i> Upload and Import Data
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Import Types Explained</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title"><i class="bi bi-magic me-2 text-primary"></i>Auto-Detect</h5>
                                <p class="card-text small">The system will analyze your file and attempt to determine the correct import method based on its contents. This works best for standard formats and PDF files.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title"><i class="bi bi-table me-2 text-success"></i>Standard Format</h5>
                                <p class="card-text small">Use this for Excel files with one record per employee per day, containing columns for Employee Name, ID, Date, Status, Time In, and Time Out.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title"><i class="bi bi-clock-history me-2 text-danger"></i>Punch Records</h5>
                                <p class="card-text small">Use this for files containing multiple check-in/check-out records throughout the day. The system will extract the first check-in as Time In and last check-in as Time Out.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Import Guide</h5>
            </div>
            <div class="card-body">
                <h6>Standard Format Required Columns:</h6>
                <ul>
                    <li>Employee Name</li>
                    <li>Employee ID</li>
                    <li>Date</li>
                    <li>Status</li>
                </ul>
                
                <h6>Punch Record Required Columns:</h6>
                <ul>
                    <li>Employee ID/No.</li>
                    <li>Employee Name</li>
                    <li>Date</li>
                    <li>Time (of punch)</li>
                </ul>
                
                <div class="alert alert-info small">
                    <i class="bi bi-lightbulb me-2"></i>
                    For punch record files, the system finds the first check-in as Time In and the last check-in as Time Out for each day.
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-tools me-2"></i>Tools</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    <a href="{{ url_for('report') }}" class="list-group-item list-group-item-action d-flex align-items-center">
                        <i class="bi bi-file-earmark-bar-graph me-3 text-success"></i>
                        <div>
                            <strong>View Reports</strong>
                            <div class="small text-muted">Check imported attendance data</div>
                        </div>
                    </a>
                    <a href="{{ url_for('search') }}" class="list-group-item list-group-item-action d-flex align-items-center">
                        <i class="bi bi-search me-3 text-primary"></i>
                        <div>
                            <strong>Search Employees</strong>
                            <div class="small text-muted">Find employees in database</div>
                        </div>
                    </a>
                    <a href="{{ url_for('weekend_work') }}" class="list-group-item list-group-item-action d-flex align-items-center">
                        <i class="bi bi-calendar2-check me-3 text-purple"></i>
                        <div>
                            <strong>Weekend Work Report</strong>
                            <div class="small text-muted">View weekend work records</div>
                        </div>
                    </a>
                    {% if session.get('logged_in') %}
                    <a href="{{ url_for('database_admin') }}" class="list-group-item list-group-item-action d-flex align-items-center">
                        <i class="bi bi-database-gear me-3 text-danger"></i>
                        <div>
                            <strong>Database Admin</strong>
                            <div class="small text-muted">Advanced database management</div>
                        </div>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>Punch Record Example</h5>
            </div>
            <div class="card-body">
                <p class="small mb-2">Punch Record files typically look like:</p>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered small">
                        <thead class="table-light">
                            <tr>
                                <th>Emp No</th>
                                <th>Name</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>123</td>
                                <td>John Doe</td>
                                <td>2025-03-09</td>
                                <td>08:02</td>
                                <td>In</td>
                            </tr>
                            <tr>
                                <td>123</td>
                                <td>John Doe</td>
                                <td>2025-03-09</td>
                                <td>12:05</td>
                                <td>Out</td>
                            </tr>
                            <tr>
                                <td>123</td>
                                <td>John Doe</td>
                                <td>2025-03-09</td>
                                <td>13:01</td>
                                <td>In</td>
                            </tr>
                            <tr>
                                <td>123</td>
                                <td>John Doe</td>
                                <td>2025-03-09</td>
                                <td>17:08</td>
                                <td>Out</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p class="small text-muted mt-2 mb-0">
                    In this example, the import tool would record 08:02 as Time In and 17:08 as Time Out.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
    function updateFileName(input) {
        const fileName = input.files[0]?.name || '';
        document.getElementById('selectedFileName').textContent = fileName;
        document.getElementById('uploadBtn').disabled = !fileName;
        
        // Style changes when file is selected
        const dropArea = document.getElementById('dragDropArea');
        if (fileName) {
            dropArea.classList.add('border-primary');
        } else {
            dropArea.classList.remove('border-primary');
        }
    }
    
    // Add drag and drop functionality
    const dropArea = document.getElementById('dragDropArea');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        dropArea.classList.add('bg-light', 'border-primary');
    }
    
    function unhighlight() {
        dropArea.classList.remove('bg-light', 'border-primary');
    }
    
    dropArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        document.getElementById('fileInput').files = files;
        updateFileName(document.getElementById('fileInput'));
    }
</script>
{% endblock %}
